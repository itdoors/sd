{% extends "::base.html.twig" %}
{% trans_default_domain 'SDTaskBundle' %}
{% block title %}{{ taskUserRole.task.title }}{% endblock %}
{% block page_breadcrumbs %}
    <ul class="page-breadcrumb breadcrumb">
        <li>
            <i class="fa fa-home"></i>
            <a href="{{ path('sd_dashboard_homepage') }}" title="{% trans %}Dashboard{% endtrans %}">{% trans %}Dashboard{% endtrans %}</a>
            <i class="fa fa-angle-right"></i>
        </li>
        <li><a href="{{ path('sd_task_homepage') }}" title="{% trans   %}Tasks{% endtrans %}">{% trans %}Tasks{% endtrans %}</a></li>
    </ul>
{% endblock %}
{% block page_title %}
    <h3 class="page-title">
        {% trans %}Tasks{% endtrans %} <small>{% trans %}Tasks list{% endtrans %}</small>
    </h3>
{% endblock %}

{% block css_page_level_plugin %}
    {{ parent() }}
    <link rel="stylesheet" type="text/css" href="{{ asset('metronic/assets/global/plugins/select2/select2.css')}} " />
    <link rel="stylesheet" type="text/css" href="{{ asset('metronic/assets/global/plugins/bootstrap-editable/bootstrap-editable/css/bootstrap-editable.css')}} " />
    <link rel="stylesheet" type="text/css" href="{{ asset('metronic/assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.css')}} " />
    <link rel="stylesheet" type="text/css" href="{{ asset('metronic/assets/global/plugins/bootstrap-datetimepicker/css/datetimepicker.css')}}" />
    <link rel="stylesheet" type="text/css" href="{{ asset('bundles/itdoorsoper/css/details.css')}}" />
{% endblock %}

{% block js_page_level_plugins %}
    {{ parent() }}
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/bootstrap-datepicker/js/bootstrap-datepicker.js')}} "></script>
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/bootstrap-datepicker/js/locales/bootstrap-datepicker.ru.js')}} "></script>
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/select2/select2.min.js') }}"></script>
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/bootstrap-editable/bootstrap-editable/js/bootstrap-editable.js') }}"></script>
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/datatables/media/js/jquery.dataTables.js') }}"></script>
    <script type="text/javascript" src="{{ asset('metronic/assets/global/plugins/datatables/plugins/bootstrap/dataTables.bootstrap.js') }}"></script>
    <script src="{{ asset('bundles/itdoorsoper/js/tabs_department_info.js')}}" ></script>
{% endblock %}

{% block body %}
<div id="holder">
<script>
    $(document).ready(function(){
        $('#task_set_viewed').die('click')
        $('#task_set_viewed').live('click', function(e){
            var id = $('#task_modal_info_holder').data('id');
            var url = $('#task_modal_info_holder').data('url_task_set_viewed');
            var sendData = {
                'id': id
            }
            $.ajax({
                type: 'POST',
                url: url,
                data: sendData,
                success: function(data1) {
                    //alert(data1)
                    data = JSON.parse(data1);
                    if (data.success == 1) {
                        update_modal();
                    } else {

                    }
                }
            })
        })

        $('.stageButton').die('click');
        $('.stageButton').live('click', function(e){
            var stage = $(this).data('stage');
            insertComment();
            updateTaskStage(stage);
        })

        $('#task_change_date').die('click');
        $('#task_change_date').live('click', function(e){
            $('#change_date_holder').toggle('blind', {}, 500)
        })

        $('.answerButton').die('click');
        $('.answerButton').live('click', function(e){
            var answer = $(this).data('value');
            var id = $('#task_modal_info_holder').data('id');
            var url = $('#task_modal_info_holder').data('url_answer_date');;
            var sendData = {
                'id': id,
                'answer': answer
            }
            $.ajax({
                type: 'POST',
                url: url,
                data: sendData,
                success: function(data1) {
                    //alert(data1)
                    data = JSON.parse(data1);
                    if (data.success == 1) {
                        insertComment();
                        update_modal();
                    } else {
                        //$('#copy_etalon_finished').show('blind', {}, 500);
                    }
                }

            })
        })

        $('.changeDate').die('click');
        $('.changeDate').live('click', function(e){
            var value = $(this).data('value');
            var type = $(this).data('type');
            var id = $('#task_modal_info_holder').data('id');
            var url = $('#task_modal_info_holder').data('url_change_date');;
            var sendData = {
                'id': id,
                'value': value,
                'type': type
            }
            $.ajax({
                type: 'POST',
                url: url,
                data: sendData,
                success: function(data1) {
                    //alert(data1)
                    data = JSON.parse(data1);
                    if (data.success == 1) {
                        insertComment()
                        update_modal();
                    } else {
                        alert('{% trans %}Somebody already made request{% endtrans %}');
                        update_modal();
                        //$('#copy_etalon_finished').show('blind', {}, 500);
                    }
                }

            })
        })

        /*
         $('#change_date_input').datetimepicker({
         'language': 'ru',
         'orientation': "auto",
         'weekStart': 0

         });
         */

        /*
         $('#task_change_date_submit').die('click');
         $('#task_change_date_submit').live('click', function(e){
         var date = $('#change_date_input').val();
         var stage = $(this).data('stage');
         })
         */

        function insertComment() {
            var comment = $('#comment').val();
            var id = $('#task_modal_info_holder').data('id');
            var url = $('#task_modal_info_holder').data('url_add_comment');
            var sendData = {
                'id': id,
                'comment': comment
            }
            //alert(comment.length)
            if (comment.length) {
                $.ajax({
                    type: 'POST',
                    url: url,
                    data: sendData,
                    success: function(data1) {
                        //alert(data1)
                        data = JSON.parse(data1);
                        if (data.success == 1) {

                        } else {
                            //$('#copy_etalon_finished').show('blind', {}, 500);
                        }
                        return true;
                    }

                })
            }

        }

        function updateTaskStage (stage) {
            var id = $('#task_modal_info_holder').data('id');
            var url = $('#task_modal_info_holder').data('url_task_set_stage');
            var sendData = {
                'id': id,
                'stage': stage
            }
            $.ajax({
                type: 'POST',
                url: url,
                data: sendData,
                success: function(data1) {
                    //alert(data1)
                    data = JSON.parse(data1);
                    if (data.success == 1) {
                        update_modal();
                    } else {
                        //$('#copy_etalon_finished').show('blind', {}, 500);
                    }
                }

            })
        }



        function update_modal() {
            location.reload();
        }


        //function update_task_list

    })

</script>

<div class="row">
    <div class="col-md-3">
        {% trans %}Performer{% endtrans %} :
        {% if taskUserRolePerformer|length %}
            {% for performer in taskUserRolePerformer %}
                {{ performer.user }}

                {% if performer.isViewed !=true %}
                    <span style="color: red; font-size: smaller;">({% trans %}Not viewed{% endtrans %})</span>
                {% endif %}
                <br>
            {% endfor %}
        {% endif %}

    </div>
    <div class="col-md-7"></div>
    <div class="col-md-2">
        {{ taskUserRole.task.startDate|date('d.m.Y') }}
    </div>
</div>

<div class="row">
    <div class="col-md-12" style="text-align: center;">
        <h1>{{ taskUserRole.task.title }}</h1>
    </div>
</div>

<div class="row">
    <div class="col-md-3"></div>
    <div class="col-md-7">
        <p style="font-size: large;">{{ taskUserRole.task.description }}</p>
    </div>
    <div class="col-md-2"></div>
</div>

<br><br>
<div class="row">
    <div class="col-md-3">
        {% trans %}Controller{% endtrans %}:
        {% if taskUserRoleController|length %}
            {% for controller in taskUserRoleController %}
                {{ controller.user }}
                {% if controller.isViewed !=true %}
                    <span style="color: red; font-size: smaller;">({% trans %}Not viewed{% endtrans %})</span>
                {% endif %}
                <br>
            {% endfor %}
        {% endif %}

        <br><br>
        {% trans %}Author{% endtrans %}: {% if taskUserRoleAuthor|length %}
            {% for author in taskUserRoleAuthor %}
                {{ author.user }}
            {% endfor %}
        {% endif %}
    </div>
    <div class="col-md-7"></div>
    <div class="col-md-2">
        {% trans %}End date{% endtrans %}:<br>
        {{ include ('SDTaskBundle:Task:taskEndDate.html.twig', {
        'taskEndDates': taskUserRole.task.taskEndDates,
        'stage': taskUserRole.task.stage
        }) }}
    </div>
</div>
<br>
<div class="row">
    <div class="col-md-3">
        {% trans %}My role{% endtrans %}: {{ taskUserRole.role|trans }}
    </div>
    <div class="col-md-7"></div>
    <div class="col-md-2">
        {% trans %}Stage{% endtrans %}: {{ taskUserRole.task.stage|trans }}
    </div>
</div>
<br>
<div style="text-align: center;">
    {% if comment is not empty %}
        <div>
            Последний комментарий ( {{ comment.user }}): <br>
            "{{ comment.value }}"
            <br><br>
        </div>
    {% endif %}
    {% if taskUserRole.isViewed != true %}
        <a id="task_set_viewed" class="btn green" style="float: right;">{% trans %}Set viewed{% endtrans %}</a>
    {% else %}

        {% if taskUserRole.role == 'performer' %}
            {% if taskUserRole.task.stage == 'created' or taskUserRole.task.stage == 'performing' or taskUserRole.task.stage == 'date request'%}
                <a id="task_set_done" data-stage="checking" class="btn purple stageButton" style="float: left;">{% trans %}Set done{% endtrans %}</a>
            {% endif %}
        {% endif %}

        {% if taskUserRole.role == 'controller' %}
            {% if taskUserRole.task.stage == 'date request'%}
                {% if taskUserRole.isViewed != true %}
                    <div style="clear: both;"></div>
                {% endif %}
                <div style="clear: both;" class="alert alert-danger">
                    {% trans %}Request to change date{% endtrans %}:
                    <a data-value="1" class="btn green answerButton" style="margin-left: 10px;">{% trans %}Submit{% endtrans %}</a>
                    <a data-value="0" class="btn red answerButton" style="margin-left: 10px;">{% trans %}Reject{% endtrans %}</a>
                </div>
                <br>
            {% endif %}

            {% if taskUserRole.task.stage == 'created' or taskUserRole.task.stage == 'performing' or taskUserRole.task.stage == 'checking' or taskUserRole.task.stage == 'date request'%}
                <a id="task_set_closed" data-stage="closed" class="btn purple stageButton" style="float: left;">{% trans %}Close task{% endtrans %}</a>
                <a id="task_set_undone" data-stage="undone" class="btn yellow stageButton" style="float: left; margin-left: 10px;">{% trans %}Set undone{% endtrans %}</a>
            {% endif %}
            {% if taskUserRole.task.stage == 'checking'%}
                <a id="task_set_done_controller" data-stage="done" class="btn red stageButton" style="float: left; margin-left: 10px;">{% trans %}Set done{% endtrans %}</a>
                <a id="task_set_performing_controller" data-stage="performing" class="btn green stageButton" style="float: left; margin-left: 10px;">{% trans %}Re-make{% endtrans %}</a>
            {% endif %}


        {% endif %}

        {% if taskUserRole.task.stage != 'date request' and taskUserRole.task.stage != 'done' and taskUserRole.task.stage != 'undone' and taskUserRole.task.stage != 'closed' and taskUserRole.task.stage != 'checking'
        and taskUserRole.role != 'author' %}
            <a id="task_change_date" data-stage="date request" class="btn red" style="float: left; margin-left: 10px;">{% trans %}Change end date{% endtrans %}</a>
            <div style="clear: both"></div>
            <div id="change_date_holder" style="display: none">
                {#
                            <br>
                            <label for="change_date_input">Change end date to:</label>
                            <input type="text" id="change_date_input">
                            <a id="task_change_date_submit" data-stage="date request" class="btn blue stageButton" style="margin-left: 10px;">{% trans %}Send request{% endtrans %}</a>
                #}
                <br>
                <a data-value="1" data-type="hour" class="btn red changeDate" style="width: 100px;">+ {% trans %}1 hour{% endtrans %}</a>
                <a data-value="3" data-type="hour" class="btn red changeDate" style="width: 100px;">+ {% trans %}3 hours{% endtrans %}</a>
                <a data-value="5" data-type="hour" class="btn red changeDate" style="width: 100px;">+ {% trans %}5 hours{% endtrans %}</a>
                <a data-value="12" data-type="hour" class="btn red changeDate" style="width: 100px;">+ {% trans %}12 hours{% endtrans %}</a>
                <br><br>
                <a data-value="1" data-type="day" class="btn blue changeDate" style="width: 100px;">+ {% trans %}1 day{% endtrans %}</a>
                <a data-value="2" data-type="day" class="btn blue changeDate" style="width: 100px;">+ {% trans %}2 days{% endtrans %}</a>
                <a data-value="3" data-type="day" class="btn blue changeDate" style="width: 100px;">+ {% trans %}3 days{% endtrans %}</a>
                <a data-value="5" data-type="day" class="btn blue changeDate" style="width: 100px;">+ {% trans %}5 days{% endtrans %}</a>
                <br><br>
                <a data-value="1" data-type="week" class="btn green changeDate" style="width: 100px;">+ {% trans %}1 week{% endtrans %}</a>
                <a data-value="2" data-type="week" class="btn green changeDate" style="width: 100px;">+ {% trans %}2 weeks{% endtrans %}</a>
                <a data-value="3" data-type="week" class="btn green changeDate" style="width: 100px;">+ {% trans %}3 weeks{% endtrans %}</a>
                <a data-value="1" data-type="month" class="btn green changeDate" style="width: 100px;">+ {% trans %}1 month{% endtrans %}</a>

            </div>
        {% endif %}
        {% if taskUserRole.task.stage != 'done' and taskUserRole.task.stage != 'undone'
        and taskUserRole.task.stage != 'closed' and taskUserRole.role != 'author' %}
            {% if taskUserRole.role != 'performer' or taskUserRole.task.stage != 'checking'%}
                <br><br>
                <label for="comment">{% trans %}Your comment{% endtrans %}</label>
                <textarea id="comment" class="form-control" placeholder="Введите комментарий к действию"></textarea>
            {% endif %}
        {% endif %}
    {% endif %}
    <br><br>

    {% if comments|length>0 %}
        {% set counter = 0 %}
        <div class="portlet" style="max-width: 900px; margin: 0px auto;">
            <div class="portlet-title line">
                <div class="caption">
                    <i class="fa fa-comments"></i>{% trans %}Comments{% endtrans %}
                </div>
    {#
                <div class="tools">
                    <a href="" class="collapse">
                    </a>
                    <a href="#portlet-config" data-toggle="modal" class="config">
                    </a>
                    <a href="" class="reload">
                    </a>
                    <a href="" class="remove">
                    </a>
                </div>
    #}
            </div>
            <div class="portlet-body" id="chats">
                    <ul class="chats">
                        {% set currentUserId = 0 %}
                        {% for comment in comments %}
                            {% if currentUserId != comment.user.id %}
                                {% set counter = counter+1 %}
                                {% set currentUserId = comment.user.id %}
                            {% endif %}
                            {% if (counter % 2) == 1 %}
                                {% set classMessage = "in" %}
                            {% else %}
                                {% set classMessage = "out" %}
                            {% endif %}

                        <li class="{{ classMessage }}">
                            <img class="avatar" alt="" src="{{ asset( userprofiles_url ~ comment.user.id ~ '/image29_' ~ comment.user.photo) }}"/>
                            <div class="message">
                                                <span class="arrow">
                                                </span>
                                <a href="#" class="name">
                                    {{ comment.user }} </a>
                                                <span class="datetime">
                                                 {{ comment.createDatetime|date('d-m-Y H:i') }} </span>
                                                <span class="body">
                                                {{ comment.value }}
                                                </span>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
    {#
                <div class="chat-form">
                    <div class="input-cont">
                        <input class="form-control" type="text" placeholder="Type a message here..."/>
                    </div>
                    <div class="btn-cont">
                                        <span class="arrow">
                                        </span>
                        <a href="" class="btn blue icn-only">
                            <i class="fa fa-check icon-white"></i>
                        </a>
                    </div>
                </div>
    #}
            </div>
        </div>
    {% endif %}

    <input type="hidden" id="task_modal_info_holder"
           data-id="{{ taskUserRole.id }}"
           data-url_task_set_viewed="{{ path('sd_task_set_viewed') }}"
           data-url_task_set_stage="{{ path('sd_task_set_stage') }}"
           data-url_update_modal="{{ path('sd_task_modal') }}"
           data-url_change_date="{{ path('sd_task_change_date') }}"
           data-url_answer_date="{{ path('sd_task_answer_date') }}"
           data-role="{{ taskUserRole.role }}"
           data-task_id="{{ taskUserRole.task.id }}"
           data-url_add_comment="{{ path('sd_task_add_comment') }}"
            >
</div>
</div>
{% endblock body %}