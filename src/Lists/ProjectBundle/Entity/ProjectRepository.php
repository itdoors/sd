<?php

namespace Lists\ProjectBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * ProjectRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProjectRepository extends EntityRepository
{
    /**
     * getListProjectSimple
     * 
     * @param User   $user
     *
     * @return Query
     */
    public function getListProjectForTender($user)
    {
        /** @var \Doctrine\ORM\QueryBuilder $sql */
        $sql = $this->createQueryBuilder('p');

        if ($user) {
            $sql
                ->leftJoin('p.managers', 'm', 'WITH', 'm.user = :user')
                ->leftJoin('p.organization', 'o')
                ->leftJoin('o.organizationUsers', 'mo', 'WITH', 'mo.user = :user')
                ->andWhere($sql->expr()->orX('m.user = :user', 'mo.user = :user'))
                ->setParameter(':user', $user);
        }
        $sql->andWhere('p INSTANCE OF :discr')
            ->setParameter(':discr', array(
                'project_simple',
                'project_commercial_tender',
                'project_electronic_trading'
            ));

        return $sql->getQuery();
    }
}
