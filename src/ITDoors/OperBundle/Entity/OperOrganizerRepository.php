<?php

namespace ITDoors\OperBundle\Entity;

use Doctrine\ORM\EntityRepository;

/**
 * OperOrganizerRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class OperOrganizerRepository extends EntityRepository
{

    /**
     * @param \Datetime $date
     * @param User      $user
     *
     * @return array
     */
    public function getDepartmentsInMonth($date, $user)
    {
        $month = $date->format('m');
        $year = $date->format('Y');
        $sql = $this->createQueryBuilder('do')
            ->select('d.id');

        $sql->leftJoin('do.department', 'd')
            ->leftJoin('do.user', 'u')

            ->where('u = (:user)')
            ->setParameter(':user', $user)
            ->andWhere('MONTH(do.startDatetime) = :month')
            ->setParameter(':month', $month)
            ->andWhere('YEAR(do.startDatetime) = :year')
            ->setParameter(':year', $year);

        return $sql->getQuery()->getResult();
    }

    public function getStatistic($date, $filter = null) {

        $sql = $this->createQueryBuilder('organizer')
/*            ->select('
            CASE
            when COUNT(organizer.id) = 0
                    then 3
                    else COUNT(organizer.id)  as count
            ');
            //->addSelect('DATE(organizer.startDatetime)');*/
        ->select( 'COUNT(organizer.id)');

/*        $sql->leftJoin('organizer.department', 'd')
            ->leftJoin('organizer.user', 'u');*/

        $sql->where('DATE(organizer.startDatetime) = :date')
            ->setParameter(':date', $date);
        //$sql->groupBy('organizer.id');

        return $sql->getQuery()->getSingleScalarResult();


    }

    public function getTotalVisits() {

        $sql = $this->createQueryBuilder('organizer')
            ->select( 'COUNT(organizer.id)');

        return $sql->getQuery()->getSingleScalarResult();
    }


    public function getTotalVisitsCommented() {

        $sql = $this->createQueryBuilder('organizer')
            ->select( 'COUNT(DISTINCT organizer.id)')

            ->innerJoin('ITDoorsOperBundle:CommentOrganizer', 'co', 'WITH', 'co.id = organizer.id');

        return $sql->getQuery()->getSingleScalarResult();
    }

    public function getAveragePerDayVisits() {

        $sql = $this->createQueryBuilder('organizer')
            ->select( 'COUNT(organizer.id)');

        return $sql->getQuery()->getSingleScalarResult();
    }

}
